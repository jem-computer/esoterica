---
phase: 08-reading-modes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/tarot/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Digital mode performs random card selection with shuf (current behavior preserved)"
    - "Physical mode prompts user with ritual moment before card entry"
    - "Physical mode accepts card names (The Tower, tower, TOWER) or numbers (16)"
    - "Physical mode prevents duplicate cards in multi-card spreads"
    - "Both modes work with single card and multi-card spreads"
  artifacts:
    - path: "skills/tarot/SKILL.md"
      provides: "Card matching function, physical mode entry flow, mode dispatch logic"
      contains: ["match_card", "get_card_name", "Physical Mode Card Entry"]
  key_links:
    - from: "Wizard Question 3 (Mode)"
      to: "Mode dispatch logic"
      via: "Mode selection determines card collection method"
    - from: "match_card function"
      to: "Physical mode entry flow"
      via: "Validates user input for card names/numbers"
---

<objective>
Implement digital and physical reading modes with fuzzy card matching

Purpose: Allow users to either use random digital card selection (current behavior) or enter cards they drew from a physical deck, supporting both single-card and multi-card spreads with forgiving input matching.

Output: Updated SKILL.md with mode dispatch logic, card matching functions, and physical mode entry flow
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-reading-modes/08-CONTEXT.md
@.planning/phases/08-reading-modes/08-RESEARCH.md
@skills/tarot/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add card matching infrastructure</name>
  <files>skills/tarot/SKILL.md</files>
  <action>
Add a new section "## Card Matching Functions" after "## Spread Selection Logic" section but before "## Reading Context".

This section provides helper logic for physical mode card entry. Include:

**match_card function description:**
- Input: User-typed card name or number
- Output: Card number (0-21) or "no match"
- Matching strategy (in order):
  1. Normalize input: lowercase, strip leading "the " prefix
  2. Exact match against card names (fool, magician, high priestess, etc.)
  3. Common variants: "wheel" for "wheel of fortune", "hanged" for "hanged man", both "judgement" and "judgment"
  4. Numeric input: validate 0-21 range
  5. No match: return failure for retry

**Card name lookup table:**
Document the mapping for all 22 Major Arcana:
- 0: The Fool
- 1: The Magician
- 2: The High Priestess
- 3: The Empress
- 4: The Emperor
- 5: The Hierophant
- 6: The Lovers
- 7: The Chariot
- 8: Strength
- 9: The Hermit
- 10: Wheel of Fortune
- 11: Justice
- 12: The Hanged Man
- 13: Death
- 14: Temperance
- 15: The Devil
- 16: The Tower
- 17: The Star
- 18: The Moon
- 19: The Sun
- 20: Judgement
- 21: The World

Format this as instruction Claude follows when validating user input, not as executable bash functions (since this is a skill prompt, not a script).
  </action>
  <verify>Read SKILL.md and confirm Card Matching Functions section exists with match_card logic and full 22-card name table</verify>
  <done>Card matching infrastructure documented in SKILL.md for physical mode validation</done>
</task>

<task type="auto">
  <name>Task 2: Implement physical mode card entry flow</name>
  <files>skills/tarot/SKILL.md</files>
  <action>
Add a new section "## Physical Mode Card Entry" after "## Card Matching Functions".

This section describes the flow when user selects "Physical deck" in wizard Question 3:

**Ritual Opening:**
"Take a moment with your cards. Shuffle while focusing on your question, then draw [N] card(s) for this reading. When you're ready, I'll guide you through entering them."

(Wait for user to indicate readiness before proceeding)

**Position-by-Position Entry (for each position in the spread):**

Prompt format: "Card for [Position Name] ([position description]):"
- For single card: "What card did you draw? (e.g., The Fool, Death, 16)"
- For multi-card: "Card for Situation (what is present now):"

**Input Validation Loop:**
For each card entry:
1. Apply match_card logic from Card Matching Functions
2. If match found:
   - Check for duplicate (if multi-card spread)
   - If duplicate: "The [Card Name] is already in your spread. Please draw another card."
   - If unique: Confirm and continue: "[Card Name] - continuing..."
3. If no match:
   - Gentle retry: "I don't recognize that card. Try the card's name (like 'The Fool' or 'Death') or its number (0-21)"
   - No retry limit - user may be checking their deck

**Duplicate Prevention:**
Track cards already entered. Reject duplicates with: "[Card Name] is already in your spread. Please draw another card."

**Summary Confirmation (multi-card only):**
After all cards entered, show summary:
"You drew:
1. [Position 1]: [Card Name]
2. [Position 2]: [Card Name]
3. [Position 3]: [Card Name]

Shall I interpret these cards? (yes to proceed, or name a position to change)"

If user wants to change a card, re-prompt for that specific position only.

**Proceed to Interpretation:**
After confirmation (or immediately for single card), proceed with the same interpretation flow as digital mode - the cards are now collected.
  </action>
  <verify>Read SKILL.md and confirm Physical Mode Card Entry section exists with ritual opening, position-by-position entry, validation loop, duplicate prevention, and summary confirmation</verify>
  <done>Physical mode card entry flow documented with ritual moment, fuzzy matching, and duplicate prevention</done>
</task>

<task type="auto">
  <name>Task 3: Update mode dispatch in wizard flow</name>
  <files>skills/tarot/SKILL.md</files>
  <action>
Update the wizard flow and spread selection to dispatch on mode properly.

**In "## Wizard: Collect Reading Parameters" section:**
Update the comment after wizard responses from:
"- Mode selection: For now, always use digital random draw regardless of selection (Phase 8 implements physical mode)"

To:
"- Mode selection: Digital uses random shuf, Physical uses card entry flow (see Physical Mode Card Entry section)"

**Add new section "## Mode Dispatch" after Physical Mode Card Entry:**

This section describes how mode selection from wizard Question 3 determines card collection:

**Digital Mode (selected "Digital (Recommended)"):**
- Use existing shuf behavior
- Single card: `!shuf -i 0-21 -n 1`
- Multi-card: `!shuf -i 0-21 -n [position_count]`
- Proceed directly to interpretation

**Physical Mode (selected "Physical deck"):**
- Display ritual opening from Physical Mode Card Entry section
- Collect cards using position-by-position entry
- Validate each card using Card Matching Functions
- Prevent duplicates in multi-card spreads
- Show summary confirmation for multi-card spreads
- Proceed to interpretation with collected cards

**Both modes produce same output:**
After mode dispatch, you have card number(s) and position name(s). The interpretation flow (Reading Instructions) is identical for both modes.

**Update Spread Selection Logic section:**
In each spread type (Single Card, Three-Card, Claude Suggests, Custom), update the card draw instruction to note it only applies to digital mode:
- Change "Draw one card using" to "For digital mode, draw using"
- Add note: "For physical mode, see Physical Mode Card Entry section"
  </action>
  <verify>Read SKILL.md and confirm: (1) wizard flow comment updated, (2) Mode Dispatch section exists with digital/physical logic, (3) Spread Selection references physical mode</verify>
  <done>Mode dispatch logic connects wizard Question 3 to correct card collection method</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Digital mode preserved:** Single card spread with digital mode should still work exactly as before (shuf randomness)

2. **Physical mode flow complete:**
   - Ritual moment before entry
   - Position context in prompts
   - Fuzzy matching (tower, The Tower, TOWER, 16 all work)
   - Duplicate prevention for multi-card
   - Summary confirmation for multi-card

3. **Both modes work with all spreads:**
   - Single card: Digital (shuf) or Physical (one card entry)
   - Three-card: Digital (shuf -n 3) or Physical (three entries with Situation/Action/Outcome prompts)
   - LLM-suggested: Both modes work with approved positions
   - Custom: Both modes work with user-defined positions

4. **No broken flows:** Wizard -> Spread -> Mode -> Cards -> Interpretation chain is complete
</verification>

<success_criteria>
- SKILL.md contains Card Matching Functions section with match_card logic and 22-card table
- SKILL.md contains Physical Mode Card Entry section with ritual, validation, duplicate prevention
- SKILL.md contains Mode Dispatch section connecting wizard Q3 to card collection
- Digital mode (shuf) behavior unchanged from Phase 7
- Physical mode supports fuzzy card name matching
- Both modes produce cards that feed into existing interpretation flow
</success_criteria>

<output>
After completion, create `.planning/phases/08-reading-modes/08-01-SUMMARY.md`
</output>
