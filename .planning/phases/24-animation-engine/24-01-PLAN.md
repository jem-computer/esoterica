---
phase: 24-animation-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - site/src/scripts/terminal-animation.js
  - site/src/styles/global.css
  - site/src/components/Terminal.astro
  - site/src/pages/index.astro
autonomous: true

must_haves:
  truths:
    - "Scrolling down through terminal section triggers phase transitions (1 -> 2 -> 3 -> 4)"
    - "Text types character-by-character at 25ms base speed with punctuation pauses"
    - "Scrolling back up re-highlights completed phases without re-animating"
    - "Indicator dots reflect current phase (active glows, completed dimmer, future hollow)"
    - "Users with prefers-reduced-motion see all text instantly"
  artifacts:
    - path: "site/src/scripts/terminal-animation.js"
      provides: "Phase detection + typewriter animation"
      min_lines: 70
    - path: "site/src/styles/global.css"
      provides: "Animation state classes (is-active, is-completed, is-hidden)"
      contains: ".terminal-line.is-active"
    - path: "site/src/components/Terminal.astro"
      provides: "Phase trigger markers in DOM"
      contains: "phase-trigger"
  key_links:
    - from: "site/src/scripts/terminal-animation.js"
      to: "IntersectionObserver"
      via: "Phase triggers with data-phase attributes"
      pattern: "IntersectionObserver.*phase-trigger"
    - from: "site/src/scripts/terminal-animation.js"
      to: "setTimeout/clearTimeout"
      via: "Typewriter with cleanup"
      pattern: "clearTimeout.*typewriterTimeoutId"
---

<objective>
Implement scroll-triggered phase detection and typewriter animation for the Terminal demo widget.

Purpose: Bring the terminal to life by animating text reveal as users scroll through the four demo phases (ask -> pull -> interpret -> integrate).

Output: Working animation system where scrolling triggers phase transitions, text types character-by-character, and phase state persists on scroll-back.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-animation-engine/24-CONTEXT.md
@.planning/phases/24-animation-engine/24-RESEARCH.md
@.planning/phases/23-terminal-foundation/23-01-SUMMARY.md
@site/src/components/Terminal.astro
@site/src/scripts/scroll-reveal.js
@site/src/styles/global.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add phase trigger markers and animation state CSS</name>
  <files>site/src/components/Terminal.astro, site/src/styles/global.css</files>
  <action>
Add invisible phase trigger markers to Terminal.astro that IntersectionObserver will detect:

In Terminal.astro, add 4 phase-trigger divs INSIDE terminal-container but OUTSIDE the sticky terminal section:
```html
<!-- Phase trigger markers - invisible, positioned absolutely -->
<div class="phase-trigger" data-phase="1" aria-hidden="true"></div>
<div class="phase-trigger" data-phase="2" aria-hidden="true"></div>
<div class="phase-trigger" data-phase="3" aria-hidden="true"></div>
<div class="phase-trigger" data-phase="4" aria-hidden="true"></div>
```

In global.css, add these new styles after the existing terminal styles:

1. Phase trigger positioning (position: absolute, invisible, at 5%/30%/55%/80% of container height)
2. Animation state classes for terminal-line:
   - Default: opacity 0.4, text hidden via clip-path or visibility (but accessible)
   - .is-active: opacity 1 (bright text, visible)
   - .is-completed: opacity 0.5 (dimmed but visible)
   - .is-typing: for the line currently being typed (cursor follows)
3. Indicator state classes:
   - .indicator.completed: opacity 0.7, softer glow than active

Note: Text must remain in DOM and accessible to screen readers even when visually hidden. Use `clip-path: inset(100%)` or similar for visual hiding that maintains accessibility.
  </action>
  <verify>
1. Run `grep -n "phase-trigger" site/src/components/Terminal.astro` - should find 4 triggers
2. Run `grep -n "is-active\|is-completed\|is-typing" site/src/styles/global.css` - should find animation state classes
3. Open browser, inspect terminal - triggers should be invisible positioned elements
  </verify>
  <done>
- 4 phase-trigger markers exist in Terminal.astro with data-phase attributes
- CSS has .is-active, .is-completed, .is-typing state classes for terminal-line
- CSS has .completed state for indicator dots
- Phase triggers positioned at 5%, 30%, 55%, 80% of 400vh container
  </done>
</task>

<task type="auto">
  <name>Task 2: Create terminal-animation.js with phase detection and typewriter</name>
  <files>site/src/scripts/terminal-animation.js</files>
  <action>
Create terminal-animation.js following the patterns from RESEARCH.md:

1. IIFE wrapper (same pattern as scroll-reveal.js)

2. Reduced motion check at top - if prefers-reduced-motion, show all text instantly and return early

3. State object:
   - currentPhase: 0
   - completedPhases: new Set()
   - typewriterTimeoutId: null
   - lastY: undefined (for direction detection)

4. Phase detection via IntersectionObserver:
   - Observe all .phase-trigger elements
   - Detect scroll direction via boundingClientRect.y comparison
   - On intersection: call handlePhaseTransition(phase, direction)
   - Threshold: 0.5, rootMargin: '0px 0px -10% 0px'

5. handlePhaseTransition(phase, direction):
   - If direction === 'down' AND phase not in completedPhases:
     - Cancel any running typewriter (clearTimeout)
     - Complete previous phase instantly if was typing
     - Start typewriter for new phase
     - Mark phase as completed when typewriter finishes
   - If direction === 'up' (scroll back):
     - Highlight phase (add is-active class) but skip animation
     - Phase was already completed, just re-highlight
   - Update indicators in both cases

6. Typewriter function:
   - Store original text in data-full-text attribute (read once at start)
   - Clear element textContent
   - Type character-by-character at 25ms base
   - Punctuation pauses: .!? = 6x delay, ,;: = 3x delay, \n = 2x delay
   - Store timeout ID for cleanup
   - Return cancel function
   - On complete: mark phase completed, move cursor

7. updateIndicators(activePhase):
   - Remove active/completed classes from all indicators
   - Add 'active' class to current phase indicator, set aria-current="step"
   - Add 'completed' class to completed phase indicators
   - Remove aria-current from non-active indicators

8. Helper: showAllPhasesInstantly() for reduced-motion fallback:
   - Add is-completed class to all terminal-line elements
   - Show all text immediately
   - Update all indicators to completed state

9. Helper: completePhaseInstantly(phase) for scroll-away mid-typing:
   - Clear timeout
   - Show full text
   - Add is-completed class
   - Add to completedPhases Set

Note: Follow existing codebase patterns - no ES6 arrow functions, use function declarations, var for compatibility.
  </action>
  <verify>
1. File exists: `ls site/src/scripts/terminal-animation.js`
2. Syntax check: `node --check site/src/scripts/terminal-animation.js`
3. Key patterns present:
   - `grep -n "IntersectionObserver" site/src/scripts/terminal-animation.js`
   - `grep -n "clearTimeout" site/src/scripts/terminal-animation.js`
   - `grep -n "prefers-reduced-motion" site/src/scripts/terminal-animation.js`
   - `grep -n "completedPhases" site/src/scripts/terminal-animation.js`
  </verify>
  <done>
- terminal-animation.js exists with phase detection and typewriter
- IntersectionObserver watches phase-trigger elements
- Direction detection via boundingClientRect.y
- Typewriter at 25ms base with punctuation pauses
- Timer cleanup via clearTimeout before new animation
- Reduced motion fallback shows all text instantly
- Scroll-back re-highlights without re-animating
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate script and verify full animation flow</name>
  <files>site/src/pages/index.astro</files>
  <action>
1. In index.astro, add script import for terminal-animation.js:
   - Add `<script src="/esoterica/scripts/terminal-animation.js"></script>` after the existing scroll-reveal.js and scroll-scrubber.js imports
   - Place inside the existing script block area at bottom of file

2. Start dev server and test the complete animation flow:
   - `cd site && npm run dev` (or equivalent)
   - Navigate to the terminal section
   - Verify each of these behaviors:
     a. Initial state: Phase 1 indicator active, phase 1 text typing
     b. Scroll down: Phases transition 1 -> 2 -> 3 -> 4
     c. Typewriter: Text appears character-by-character
     d. Punctuation: Brief pauses at periods, commas
     e. Scroll back up: Completed phases re-highlight without re-typing
     f. Indicators: Active dot glows, completed dots dimmer, future hollow

3. Test reduced motion:
   - In browser DevTools, simulate prefers-reduced-motion: reduce
   - Reload page - all text should be visible immediately
   - No typewriter animation should occur

4. Memory leak check:
   - Open DevTools Performance tab
   - Scroll rapidly through all phases multiple times
   - Check no orphaned timers accumulating
  </action>
  <verify>
1. Script import present: `grep -n "terminal-animation.js" site/src/pages/index.astro`
2. Dev server runs without errors: `cd site && npm run dev` (check for console errors)
3. Manual verification of all animation behaviors listed above
  </verify>
  <done>
- terminal-animation.js imported in index.astro
- Scrolling triggers phase transitions (SCRL-01, SCRL-02)
- Text types character-by-character at 25ms (TYPE-01, TYPE-02)
- Scroll-back shows completed state without re-animation (SCRL-03)
- Timer cleanup prevents memory leaks (TYPE-03)
- Reduced motion shows all text instantly (a11y)
  </done>
</task>

</tasks>

<verification>
## Overall Phase Verification

After all tasks complete:

1. **Requirements check:**
   - SCRL-01: ✓ Four scroll-triggered phases (verified by scrolling through demo)
   - SCRL-02: ✓ IntersectionObserver detects phase transitions (grep for pattern)
   - SCRL-03: ✓ Phase persistence on scroll-back (manual test)
   - TYPE-01: ✓ Character-by-character reveal (manual observation)
   - TYPE-02: ✓ 25ms base typing speed (code inspection)
   - TYPE-03: ✓ Timer cleanup (clearTimeout before new animation)

2. **Context decisions honored:**
   - Previous phase text dims when entering new phase (is-completed class)
   - Cursor follows last typed character (handled in typewriter)
   - Text completes instantly on scroll-away (completePhaseInstantly)
   - Punctuation pauses for natural rhythm (delay multipliers)
   - Active indicator glows, completed dimmer, future hollow (CSS classes)

3. **Accessibility:**
   - All text in DOM from start (Phase 23)
   - Reduced motion fallback shows text instantly
   - aria-current="step" on active indicator
   - aria-live="polite" on terminal-screen (Phase 23)
</verification>

<success_criteria>
1. Scrolling down through terminal section triggers phases 1 -> 2 -> 3 -> 4
2. Each phase's text types character-by-character at ~25ms per character
3. Punctuation causes brief typing pauses
4. Scrolling back up re-highlights completed phases without re-animating
5. Indicator dots update correctly (active glows, completed dimmer)
6. Users with prefers-reduced-motion see all text instantly
7. No console errors during animation
8. No memory leaks from orphaned timers
</success_criteria>

<output>
After completion, create `.planning/phases/24-animation-engine/24-01-SUMMARY.md`
</output>
